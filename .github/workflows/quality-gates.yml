name: Quality Gates

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  code-style:
    name: Code Style Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check file naming
      run: |
        echo "Checking file naming conventions..."
        for file in *.h; do
          if [[ ! "$file" =~ ^[a-z_]+\.h$ ]]; then
            echo "ERROR: File '$file' does not follow naming convention (lowercase_with_underscores.h)"
            exit 1
          fi
        done
        echo "File naming: PASS"
    
    - name: Check include guards
      run: |
        echo "Checking include guards..."
        for file in *.h; do
          guard=$(echo "$file" | tr 'a-z' 'A-Z' | tr '.' '_')
          if ! grep -q "#ifndef $guard" "$file" || ! grep -q "#define $guard" "$file"; then
            echo "ERROR: Include guard issue in $file - expected format: $guard"
            exit 1
          fi
        done
        echo "Include guards: PASS"
    
    - name: Check line lengths
      run: |
        echo "Checking line lengths (max 120 characters)..."
        for file in *.h; do
          long_lines=$(grep -n '.\{121\}' "$file" | grep -v "http" || true)
          if [ -n "$long_lines" ]; then
            echo "WARNING: Long lines found in $file:"
            echo "$long_lines"
            # Don't fail, just warn
          fi
        done
        echo "Line length check completed"

  security-validation:
    name: Security Rules Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate security limits
      run: |
        echo "Validating security limits..."
        
        # Check that security constants are defined
        for constant in MAX_STRING_LENGTH MAX_VARIABLE_NAME_LENGTH MAX_EXPRESSION_DEPTH; do
          if ! grep -r "$constant" *.h > /dev/null; then
            echo "ERROR: Security constant $constant not found"
            exit 1
          fi
        done
        
        # Verify pin safety checks exist
        if ! grep -r "isPinAllowed" *.h > /dev/null; then
          echo "ERROR: Pin safety check (isPinAllowed) not found"
          exit 1
        fi
        
        echo "Security validation: PASS"

  resource-limits:
    name: Resource Limits Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check stack size
      run: |
        echo "Checking stack size definitions..."
        if grep -r "stack\[64\]" *.h > /dev/null; then
          echo "INFO: Stack size is 64 - appropriate for ESP32"
        else
          echo "WARNING: Check stack size allocation"
        fi
    
    - name: Check memory allocations
      run: |
        echo "Checking for dynamic memory issues..."
        
        # Look for potential memory issues
        if grep -r "new " *.h || grep -r "malloc" *.h; then
          echo "WARNING: Found dynamic memory allocation - ensure proper cleanup for embedded system"
        else
          echo "No dynamic memory allocation found - good for embedded"
        fi
        
        # Check vector reservations
        echo "Vector reservations found:"
        grep -n "reserve(" *.h || echo "None found"

  dependency-check:
    name: Dependency Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate Arduino dependencies
      run: |
        echo "Checking Arduino dependencies..."
        
        required_includes=("Arduino.h" "vector" "map" "stack" "cmath")
        for include in "${required_includes[@]}"; do
          if ! grep -r "#include.*$include" *.h > /dev/null; then
            echo "WARNING: $include may be missing but required"
          fi
        done
        
        echo "Dependency check completed"