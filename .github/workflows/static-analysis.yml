name: Static Code Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  cppcheck:
    name: CppCheck Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install cppcheck
      run: sudo apt-get update && sudo apt-get install -y cppcheck
    
    - name: Run cppcheck
      run: |
        echo "Running cppcheck..."
        cppcheck --enable=warning,performance,portability,style \
                 --suppress=missingIncludeSystem \
                 --inline-suppr \
                 --error-exitcode=1 \
                 *.h 2> cppcheck_results.txt || true
        
        # Show results but don't fail the build for warnings
        cat cppcheck_results.txt
        echo "CppCheck analysis completed"

  clang-tidy:
    name: Clang-Tidy Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install clang-tidy
      run: sudo apt-get update && sudo apt-get install -y clang-tidy
    
    - name: Create compilation database simulation
      run: |
        cat > compile_commands.json << 'EOF'
        [
          {
            "directory": "$(pwd)",
            "command": "g++ -std=c++11 -I. -c xeno_common.h",
            "file": "xeno_common.h"
          },
          {
            "directory": "$(pwd)", 
            "command": "g++ -std=c++11 -I. -c xeno_compiler.h",
            "file": "xeno_compiler.h"
          },
          {
            "directory": "$(pwd)",
            "command": "g++ -std=c++11 -I. -c xeno_security.h", 
            "file": "xeno_security.h"
          },
          {
            "directory": "$(pwd)",
            "command": "g++ -std=c++11 -I. -c xeno_vm.h",
            "file": "xeno_vm.h"
          }
        ]
        EOF
    
    - name: Run clang-tidy
      run: |
        echo "Running clang-tidy..."
        # Run basic checks without full compilation database
        for file in *.h; do
          echo "Analyzing $file"
          clang-tidy -checks='-*,readability-*,-readability-braces-around-statements' \
                     -header-filter='.*' \
                     "$file" -- -std=c++11 -I. || true
        done
        echo "Clang-tidy analysis completed"

  complexity-check:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install complexity tools
      run: |
        sudo apt-get update && sudo apt-get install -y \
          pmccabe \
          sloccount
    
    - name: Calculate code metrics
      run: |
        echo "=== Code Metrics ==="
        echo "Lines of code per file:"
        wc -l *.h
        
        echo "=== File sizes ==="
        ls -la *.h | awk '{print $5 "\t" $9}'
        
        echo "=== Basic complexity analysis ==="
        for file in *.h; do
          echo "File: $file"
          # Count class/struct definitions
          classes=$(grep -c "^class\|^struct" "$file" || true)
          methods=$(grep -c ") {" "$file" || true)
          echo "  Classes/Structs: $classes, Methods: $methods"
        done
        
        echo "Complexity analysis completed"