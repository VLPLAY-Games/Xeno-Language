name: CI/CD - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build XenoVM and Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
      with:
        version: '0.35.0'
    
    - name: Install ESP32 platform
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32
    
    - name: Create test sketch
      run: |
        mkdir -p test_project/src
        cat > test_project/src/test_project.ino << 'EOF'
        #include "xeno_common.h"
        #include "xeno_compiler.h" 
        #include "xeno_security.h"
        #include "xeno_vm.h"
        
        XenoCompiler compiler;
        XenoVM vm;
        
        void setup() {
          Serial.begin(115200);
          delay(1000);
          
          // Test compilation
          String test_code = "print \"Hello Xeno\"\nled 13 on\ndelay 1000\nled 13 off\nhalt";
          compiler.compile(test_code);
          
          // Test VM loading
          vm.loadProgram(compiler.getBytecode(), compiler.getStringTable());
          
          Serial.println("XenoVM CI Test: BUILD SUCCESS");
        }
        
        void loop() {
          // Empty
        }
        EOF
        
        # Copy header files
        cp *.h test_project/src/
    
    - name: Compile test project
      run: |
        cd test_project/src
        arduino-cli compile --fqbn esp32:esp32:esp32 ./
    
    - name: Run basic syntax tests
      run: |
        echo "Running basic compiler tests..."
        cat > test_compiler.cpp << 'EOF'
        #include <iostream>
        #include <vector>
        #include <string>
        
        // Minimal test to verify headers compile
        int main() {
          std::vector<std::string> test_strings = {"test1", "test2"};
          std::cout << "Header compilation test: PASS" << std::endl;
          return 0;
        }
        EOF
        
        g++ -std=c++11 -c test_compiler.cpp -o test_compiler.o
        echo "Basic compilation test: PASS"
    
    - name: Security scan
      run: |
        echo "Running basic security checks..."
        # Check for basic security issues in headers
        if grep -r "strcpy" *.h; then
          echo "WARNING: Found strcpy - consider using safer alternatives"
          exit 1
        fi
        
        if grep -r "sprintf" *.h; then
          echo "WARNING: Found sprintf - consider using snprintf"
          exit 1
        fi
        
        echo "Basic security checks: PASS"

  memory-check:
    name: Memory Usage Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Analyze memory usage
      run: |
        echo "Analyzing memory usage patterns..."
        # Check for large stack allocations
        if grep -n "stack\[.*\]" *.h; then
          echo "INFO: Found stack arrays - verify sizes are reasonable for ESP32"
        fi
        
        # Check vector reservations
        if grep -n "reserve(" *.h; then
          echo "INFO: Found vector reservations - verify sizes are ESP32 appropriate"
        fi
        
        echo "Total lines of code in headers:"
        wc -l *.h

  documentation-check:
    name: Documentation Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check documentation
      run: |
        echo "Checking documentation quality..."
        
        # Check for file headers
        for file in *.h; do
          if [ ! -s "$file" ]; then
            continue
          fi
          if ! head -n 5 "$file" | grep -q "Xeno"; then
            echo "WARNING: $file may be missing proper header"
          fi
        done
        
        echo "Documentation check completed"